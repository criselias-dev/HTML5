<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Night Sky Audio Reactive</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
}

canvas {
    display: block;
}

#audioControl {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    color: #ccc;
    font-family: Arial, sans-serif;
    font-size: 13px;
    opacity: 0.85;
}
</style>
</head>

<body>

<div id="audioControl">
    <input type="file" id="audioFile" accept="audio/*">
</div>

<canvas id="canvas"></canvas>

<script>
/* =========================
   CANVAS
========================= */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

/* =========================
   CONFIGURAÇÕES
========================= */

const STAR_COUNT = 1200;
const STAR_COLORS = [
    'rgba(180,200,255,1)',
    'rgba(220,220,255,1)',
    'rgba(255,170,170,1)'
];

const MAX_DISTANCE = 50;
const BASE_LINKS = 10;

let velocityFactor = 1;
let kickEnergy = 0;

/* =========================
   PARTÍCULAS
========================= */

class Star {
    constructor() {
        this.reset();
    }

    reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.radius = Math.random() * 1.5 + 0.8;

        this.speedX = (Math.random() - 0.5) * 1.8;
        this.speedY = (Math.random() - 0.5) * 1.8;

        this.life = Math.random() * 600 + 500;
        this.color = STAR_COLORS[Math.floor(Math.random() * STAR_COLORS.length)];
    }

    update() {
        this.x += this.speedX * velocityFactor;
        this.y += this.speedY * velocityFactor;

        this.life--;

        if (
            this.x < -50 || this.x > canvas.width + 50 ||
            this.y < -50 || this.y > canvas.height + 50 ||
            this.life <= 0
        ) {
            this.reset();
        }
    }

    draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius + kickEnergy * 0.6, 0, Math.PI * 2);
    ctx.fillStyle = this.color;
    ctx.fill();
}

}

const stars = Array.from({ length: STAR_COUNT }, () => new Star());

/* =========================
   ÁUDIO / WEB AUDIO API
========================= */

let audioCtx, analyser, dataArray;

document.getElementById('audioFile').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    if (audioCtx) audioCtx.close();

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;

    const source = audioCtx.createMediaElementSource(new Audio(URL.createObjectURL(file)));
    source.mediaElement.loop = true;
    source.mediaElement.play();

    source.connect(analyser);
    analyser.connect(audioCtx.destination);

    dataArray = new Uint8Array(analyser.frequencyBinCount);
});

/* =========================
   KICK DETECTION SIMPLES
========================= */

function detectKick() {
    if (!analyser) return;

    analyser.getByteFrequencyData(dataArray);

    let lowEnergy = 0;
    const bassBins = 8;

    for (let i = 0; i < bassBins; i++) {
        lowEnergy += dataArray[i];
    }

    lowEnergy /= bassBins;

    if (lowEnergy > 180) {
        kickEnergy = 1;
        velocityFactor += 0.35;
    }
}

/* =========================
   LOOP PRINCIPAL
========================= */

function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    detectKick();

    velocityFactor *= 0.96;
    velocityFactor = Math.min(velocityFactor, 3);

    // Estrelas
    for (let s of stars) {
        s.update();
        s.draw();
    }

    // Constelações
    const linkAlpha = 0.5 + kickEnergy * 0.15;
    const linkWidth = 0.1 + kickEnergy * 0.5;
    const dynamicDistance = MAX_DISTANCE + kickEnergy * 50;

    for (let i = 0; i < stars.length; i++) {
        let links = 0;

        for (let j = i + 1; j < stars.length && links < BASE_LINKS; j++) {
            const dx = stars[i].x - stars[j].x;
            const dy = stars[i].y - stars[j].y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < dynamicDistance) {
                ctx.beginPath();
                ctx.strokeStyle = `rgba(160,190,255,${linkAlpha})`;
                ctx.lineWidth = linkWidth;
                ctx.moveTo(stars[i].x, stars[i].y);
                ctx.lineTo(stars[j].x, stars[j].y);
                ctx.stroke();
                links++;
            }
        }
    }

    kickEnergy *= 0.9;

    requestAnimationFrame(animate);
}

animate();
</script>

</body>
</html>
